version: 2.1
description: "Static Site Starter Orb"

display:
  source_url: https://github.com/devheart/static-site-starter-orb

commands:
  build:
    - run:
        name: SSS - build
        command: yarn build

  install:
    steps:
      - yarn_install
      - bundle_install

  firebase_deploy:
    description: "Deploy to Firebase"
    parameters:
      project_id:
        type: string
      token:
        type: string
    steps:
      - run:
          name: SSS - firebase/deploy
          command: ./node_modules/.bin/firebase deploy --non-interactive --project "<< parameters.project_id >>" --token "<< parameters.token >>"

  yarn_install:
    description: "Install yarn dependencies"
    steps:
      - restore_cache:
          name: SSS - yarn/restore_cache
          keys:
            - yarn-{{ checksum "yarn.lock" }}
            - yarn-
      - run:
          name: SSS - yarn/install
          command: yarn install --frozen-lockfile
      - save_cache:
          name: SSS - yarn/save_cache
          key: yarn-{{ checksum "yarn.lock" }}
          paths:
            - ~/.cache/yarn

  bundle_install:
    description: "Install bundles"
    steps:
      - run:
          name: SSS - bundles/gem_config_optimization
          command: |
            echo "gem: --no-rdoc --no-ri" >> jekyll/.gemrc
            echo "gem: --no-document" >> jekyll/.gemrc
      - run:
          name: SSS - bundles/update_bundler
          command: |
            gem install bundler
            sudo chown -R circleci /usr/local/bundle
            bundler --version
      - restore_cache:
          name: SSS - bundles/restore_cache
          keys:
            - bundles-{{ checksum "jekyll/Gemfile.lock" }}
            - bundles-
      - run:
          name: SSS - bundles/install
          command: cd jekyll && bundle install
      - save_cache:
          name: SSS - bundles/save_cache
          paths:
            - /usr/local/bundle
          key: bundles-{{ checksum "jekyll/Gemfile.lock" }}

jobs:
  build_and_deploy:
    docker:
      - image: circleci/ruby:2.7-node
    environment:
      JEKYLL_ENV: production
    steps:
      - checkout
      - install
      - build
      - firebase_deploy:
          project_id: $FIREBASE_PROJECT_ID
          token: $FIREBASE_TOKEN
